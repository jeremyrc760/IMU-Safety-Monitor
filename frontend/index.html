<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TransferLog IMU Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .metric { flex:1 1 140px; background:#fafafa; border-radius:12px; padding:12px; text-align:center; }
    .label { font-size:12px; color:#6b7280; }
    .value { font-size:22px; font-weight:700; margin-top:4px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>TransferLog IMU Dashboard</h1>
  <div class="card">
    <div id="status">Connecting...</div>
  </div>

  <div class="card">
    <h3>Accelerometer (m/s²)</h3>
    <div class="row">
      <div class="metric"><div class="label">ax</div><div id="ax" class="value">-</div></div>
      <div class="metric"><div class="label">ay</div><div id="ay" class="value">-</div></div>
      <div class="metric"><div class="label">az</div><div id="az" class="value">-</div></div>
    </div>
  </div>

  <div class="card">
    <h3>Gyroscope (°/s)</h3>
    <div class="row">
      <div class="metric"><div class="label">gx</div><div id="gx" class="value">-</div></div>
      <div class="metric"><div class="label">gy</div><div id="gy" class="value">-</div></div>
      <div class="metric"><div class="label">gz</div><div id="gz" class="value">-</div></div>
    </div>
  </div>

  <div class="card">
    <h3>ax Live Chart (last 60s)</h3>
    <canvas id="axChart" height="110"></canvas>
  </div>

  <script type="module">
    import API_BASE from './config.js';
    const base = API_BASE || `${location.protocol}//${location.host}`;

    const s = document.getElementById('status');
    const ids = ['ax','ay','az','gx','gy','gz'];
    const els = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));

    const ctx = document.getElementById('axChart').getContext('2d');
    const labels = [];
    const dataPoints = [];
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'ax', data: dataPoints, tension: 0.2, pointRadius: 0 }]},
      options: { animation:false, responsive:true, scales:{x:{display:false}} }
    });

    async function tick(){
      try {
        const r = await fetch(`${base}/api/imu`, {cache: 'no-store'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();

        ids.forEach(k => els[k].textContent = Number(j[k]).toFixed(2));
        s.textContent = `Last update: ${j.ts || 'n/a'}  •  source: ${base}`;

        const nowLabel = new Date().toLocaleTimeString();
        labels.push(nowLabel);
        dataPoints.push(Number(j.ax));
        if (labels.length > 60) { labels.shift(); dataPoints.shift(); }
        chart.update();
      } catch (e) {
        s.textContent = 'Error: ' + e.message + `  •  base=${base}`;
      }
    }

    setInterval(tick, 1000);
    tick();
  </script>
</body>
</html>
